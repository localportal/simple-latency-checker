<!DOCTYPE html>
<html>
  <head>
    <title>Dropdown Test</title>
    <style>
      #status {
        margin-top: 20px;
      }
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .left-section,
      .right-section {
        flex: 1;
        padding: 20px;
      }
      .ws-section {
        flex: 1;
        padding: 20px;
      }
      .right-section {
        display: flex;
        flex-direction: row;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Left Section for HTTP -->
      <div class="left-section">
        <select id="numberDropdown">
          <option value="0">0</option>
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
        <button onclick="sendHttpRequest()">Send HTTP</button>
        <div id="httpStatus"></div>
      </div>

      <!-- Right Section for WebSocket -->
      <div class="right-section">
        <div class="ws-section" id="ws1">
          <button onclick="sendWebSocketRequest('ws1')">Send Hi</button>
          <div class="ws-status"></div>
        </div>
        <div class="ws-section" id="ws2">
          <button onclick="sendWebSocketRequest('ws2')">Send Hi</button>
          <div class="ws-status"></div>
        </div>
        <div class="ws-section" id="ws3">
          <button onclick="sendWebSocketRequest('ws3')">Send Hi</button>
          <div class="ws-status"></div>
        </div>
      </div>
    </div>

    <script>
      let wsConnections = {};

      function sendHttpRequest() {
        document.getElementById("httpStatus").innerHTML = "";

        let value = parseInt(document.getElementById("numberDropdown").value);

        for (let i = 0; i < value; i++) {
          let startTime = new Date();
          fetch(`/http?number=${i + 1}`, { method: "GET" })
            .then((response) => {
              let endTime = new Date();
              let timeDiff = endTime - startTime;
              let newStatus = document.createElement("div");
              newStatus.innerText = `HTTP Request ${i + 1}: Status: ${
                response.status
              }, Time: ${timeDiff}ms`;
              document.getElementById("httpStatus").appendChild(newStatus);
            })
            .catch((error) => {
              let newStatus = document.createElement("div");
              newStatus.innerText = `HTTP Request ${i + 1}: Error: ${error}`;
              document.getElementById("httpStatus").appendChild(newStatus);
            });
        }
      }

      function initWebSocket(sectionId) {
        let ws = new WebSocket("wss://hola.lp.link:8001/websocket");
        ws.onopen = function (event) {
          ws.isReady = true;
          if (ws.queuedMessage) {
            ws.send(ws.queuedMessage);
            ws.queuedMessage = null;
          }
        };
        ws.addEventListener("message", function (event) {
          let endTime = new Date();
          let timeDiff = endTime - ws.startTime;
          document.querySelector(
            `#${sectionId} .ws-status`
          ).innerText = `Round-trip time: ${timeDiff}ms`;
        });
        return ws;
      }

      function sendWebSocketRequest(sectionId) {
        if (!wsConnections[sectionId]) {
          wsConnections[sectionId] = initWebSocket(sectionId);
        }
        let ws = wsConnections[sectionId];
        ws.startTime = new Date();

        const checkConnection = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            clearInterval(checkConnection);
            ws.send("Hi");
          } else {
            console.log(
              `WebSocket in section ${sectionId} is not yet connected. Trying again.`
            );
          }
        }, 100); // Check every 100ms
      }
    </script>
  </body>
</html>
